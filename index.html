<!doctype html>
<html lang="pt-BR" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Urna Eletr√¥nica NGv - Nosso Governo Virtual</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&amp;display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6B21A8',
            'primary-dark': '#581C87',
            'primary-light': '#9333EA',
            accent: '#A855F7',
            surface: '#FAFAFA',
            'surface-dark': '#F3E8FF'
          },
          fontFamily: {
            montserrat: ['Montserrat', 'sans-serif']
          }
        }
      }
    }
  </script>
  <style>
    * { font-family: 'Montserrat', sans-serif; }
    .urna-screen {
      background: linear-gradient(180deg, #1a1a1a 0%, #2d2d2d 100%);
      border: 4px solid #4a4a4a;
      border-radius: 8px;
    }
    .urna-keyboard {
      background: linear-gradient(180deg, #3d3d3d 0%, #2a2a2a 100%);
    }
    .urna-btn {
      background: linear-gradient(180deg, #4a4a4a 0%, #3a3a3a 100%);
      border: 2px solid #5a5a5a;
      transition: all 0.1s ease;
    }
    .urna-btn:active {
      transform: scale(0.95);
      background: linear-gradient(180deg, #3a3a3a 0%, #2a2a2a 100%);
    }
    .urna-btn-white { background: linear-gradient(180deg, #f0f0f0 0%, #d0d0d0 100%); color: #333; }
    .urna-btn-orange { background: linear-gradient(180deg, #f97316 0%, #ea580c 100%); }
    .urna-btn-green { background: linear-gradient(180deg, #22c55e 0%, #16a34a 100%); }
    .number-display {
      background: #000;
      border: 2px solid #333;
      font-family: 'Courier New', monospace;
    }
    .candidate-photo {
      border: 3px solid #6B21A8;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    .glass-effect {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
    }
  </style>
  <style>body { box-sizing: border-box; }</style>
 </head>
 <body class="h-full bg-gradient-to-br from-purple-50 via-white to-purple-100 font-montserrat overflow-auto">
  <div id="app" class="w-full min-h-full"><!-- Header -->
   <header class="bg-primary text-white py-4 px-6 shadow-lg">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
     <div class="flex items-center gap-3">
      <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center">
       <svg class="w-8 h-8 text-primary" fill="currentColor" viewbox="0 0 24 24"><path d="M18 13h-5v5c0 .55-.45 1-1 1s-1-.45-1-1v-5H6c-.55 0-1-.45-1-1s.45-1 1-1h5V6c0-.55.45-1 1-1s1 .45 1 1v5h5c.55 0 1 .45 1 1s-.45 1-1 1z" />
       </svg>
      </div>
      <div>
       <h1 id="header-title" class="text-xl font-bold">Urna Eletr√¥nica NGv</h1>
       <p id="header-subtitle" class="text-purple-200 text-sm">Nosso Governo Virtual</p>
      </div>
     </div>
     <nav id="nav-menu" class="flex gap-2"><button onclick="showPage('home')" class="px-4 py-2 rounded-lg hover:bg-primary-dark transition text-sm font-medium">In√≠cio</button> <button onclick="showPage('register')" class="px-4 py-2 rounded-lg hover:bg-primary-dark transition text-sm font-medium">Cadastro</button> <button onclick="showPage('admin-login')" class="px-4 py-2 rounded-lg hover:bg-primary-dark transition text-sm font-medium">Admin</button>
     </nav>
    </div>
   </header><!-- Home Page -->
   <main id="page-home" class="page max-w-6xl mx-auto px-6 py-12">
    <div class="text-center mb-12 fade-in">
     <div class="inline-flex items-center gap-2 bg-purple-100 text-primary px-4 py-2 rounded-full text-sm font-medium mb-6"><span class="w-2 h-2 bg-primary rounded-full animate-pulse"></span> Simula√ß√£o Fict√≠cia para RPG
     </div>
     <h2 class="text-4xl md:text-5xl font-extrabold text-gray-800 mb-4">Sistema de <span class="text-primary">Vota√ß√£o Eletr√¥nica</span></h2>
     <p class="text-gray-600 text-lg max-w-2xl mx-auto">Bem-vindo ao sistema de urna eletr√¥nica do Nosso Governo Virtual. Esta √© uma simula√ß√£o eleitoral fict√≠cia exclusiva para o RPG de Discord.</p>
    </div>
    <div class="grid md:grid-cols-2 gap-8 mb-12">
     <div class="bg-white rounded-2xl p-8 shadow-xl border border-purple-100 hover:shadow-2xl transition fade-in">
      <div class="w-16 h-16 bg-primary/10 rounded-2xl flex items-center justify-center mb-6">
       <svg class="w-8 h-8 text-primary" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
       </svg>
      </div>
      <h3 class="text-2xl font-bold text-gray-800 mb-3">Cadastrar Eleitor</h3>
      <p class="text-gray-600 mb-6">Registre seu personagem como eleitor e receba seu c√≥digo √∫nico de vota√ß√£o.</p><button onclick="showPage('register')" class="w-full bg-primary hover:bg-primary-dark text-white py-3 px-6 rounded-xl font-semibold transition transform hover:scale-[1.02]"> Iniciar Cadastro </button>
     </div>
     <div class="bg-white rounded-2xl p-8 shadow-xl border border-purple-100 hover:shadow-2xl transition fade-in">
      <div class="w-16 h-16 bg-primary/10 rounded-2xl flex items-center justify-center mb-6">
       <svg class="w-8 h-8 text-primary" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
       </svg>
      </div>
      <h3 class="text-2xl font-bold text-gray-800 mb-3">Administra√ß√£o</h3>
      <p class="text-gray-600 mb-6">Acesso exclusivo para gerenciamento de candidatos, partidos e elei√ß√µes.</p><button onclick="showPage('admin-login')" class="w-full bg-gray-800 hover:bg-gray-900 text-white py-3 px-6 rounded-xl font-semibold transition transform hover:scale-[1.02]"> Acessar Painel </button>
     </div>
    </div>
    <div class="bg-gradient-to-r from-primary to-primary-light rounded-2xl p-8 text-white fade-in">
     <div class="flex items-start gap-4">
      <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center flex-shrink-0">
       <svg class="w-6 h-6" fill="currentColor" viewbox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" />
       </svg>
      </div>
      <div>
       <h4 class="text-xl font-bold mb-2">Aviso Importante</h4>
       <p class="text-purple-100">Este √© um sistema de simula√ß√£o eleitoral <strong>100% fict√≠cio</strong>, desenvolvido exclusivamente para fins de entretenimento no RPG "Nosso Governo Virtual" do Discord. N√£o possui qualquer rela√ß√£o com elei√ß√µes reais ou sistemas oficiais de vota√ß√£o.</p>
      </div>
     </div>
    </div>
   </main><!-- Register Page -->
   <main id="page-register" class="page hidden max-w-xl mx-auto px-6 py-12">
    <div class="bg-white rounded-2xl p-8 shadow-xl border border-purple-100 fade-in">
     <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Cadastro de Eleitor</h2>
     <div id="register-form">
      <div class="space-y-4">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Usu√°rio do Discord</label> <input type="text" id="discord-user" placeholder="Ex: usuario#1234" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none transition">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Nome do Personagem</label> <input type="text" id="character-name" placeholder="Ex: Jo√£o da Silva" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none transition">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Estado</label> <select id="voter-state" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none transition bg-white"> <option value="">Selecione seu estado...</option> <option value="AM">Amazonas</option> <option value="SP">S√£o Paulo</option> <option value="GO">Goi√°s</option> <option value="RS">Rio Grande do Sul</option> <option value="PE">Pernambuco</option> </select>
       </div>
      </div><button onclick="registerVoter()" id="btn-register" class="w-full mt-6 bg-primary hover:bg-primary-dark text-white py-3 px-6 rounded-xl font-semibold transition"> Gerar C√≥digo de Vota√ß√£o </button>
     </div>
     <div id="register-success" class="hidden text-center">
      <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
       <svg class="w-10 h-10 text-green-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
       </svg>
      </div>
      <h3 class="text-xl font-bold text-gray-800 mb-2">Cadastro Realizado!</h3>
      <p class="text-gray-600 mb-6">Seu c√≥digo √∫nico de vota√ß√£o:</p>
      <div class="bg-gray-100 rounded-xl p-4 mb-4">
       <p id="voting-code" class="text-3xl font-mono font-bold text-primary tracking-wider"></p>
      </div>
      <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
       <p class="text-yellow-800 text-sm font-medium">‚ö†Ô∏è <strong>ATEN√á√ÉO:</strong> Este c√≥digo s√≥ pode ser usado UMA VEZ. Copie e tire um print para n√£o perder!</p>
      </div><button onclick="goToVoting()" class="w-full bg-primary hover:bg-primary-dark text-white py-3 px-6 rounded-xl font-semibold transition"> Ir para Vota√ß√£o </button>
     </div>
    </div>
   </main><!-- Voting Code Entry -->
   <main id="page-voting-entry" class="page hidden max-w-xl mx-auto px-6 py-12">
    <div class="bg-white rounded-2xl p-8 shadow-xl border border-purple-100 fade-in">
     <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Acesso √† Urna</h2>
     <div class="space-y-4">
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Digite seu C√≥digo de Vota√ß√£o</label> <input type="text" id="entry-code" placeholder="Ex: NGV-XXXXXX" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none transition text-center text-xl font-mono uppercase">
      </div>
      <p id="code-error" class="text-red-500 text-sm text-center hidden"></p>
     </div><button onclick="validateCode()" id="btn-validate" class="w-full mt-6 bg-primary hover:bg-primary-dark text-white py-3 px-6 rounded-xl font-semibold transition"> Acessar Urna </button>
    </div>
   </main><!-- Voting Machine -->
   <main id="page-voting" class="page hidden max-w-4xl mx-auto px-6 py-8">
    <div class="bg-gray-800 rounded-3xl p-6 shadow-2xl fade-in">
     <div class="flex flex-col lg:flex-row gap-6"><!-- Screen -->
      <div class="flex-1">
       <div class="urna-screen p-6 min-h-[400px]">
        <div id="voting-content">
         <p id="cargo-label" class="text-green-400 text-lg font-bold mb-4 uppercase"></p>
         <div class="flex gap-6">
          <div class="flex-1">
           <p class="text-gray-400 text-sm mb-1">N√∫mero:</p>
           <div id="number-display" class="number-display text-green-400 text-4xl font-bold p-3 mb-4 tracking-widest min-h-[60px]"></div>
           <div id="candidate-info" class="hidden">
            <p class="text-gray-400 text-sm">Nome:</p>
            <p id="candidate-name" class="text-white text-xl font-bold mb-2"></p>
            <p class="text-gray-400 text-sm">Partido:</p>
            <p id="candidate-party" class="text-white text-lg mb-2"></p>
            <div id="vice-info" class="hidden mt-4">
             <p class="text-gray-400 text-sm">Vice:</p>
             <p id="vice-name" class="text-white text-lg"></p>
            </div>
           </div>
           <div id="vote-null" class="hidden">
            <p class="text-red-500 text-2xl font-bold mt-4">VOTO NULO</p>
           </div>
           <div id="vote-blank" class="hidden">
            <p class="text-white text-2xl font-bold mt-4">VOTO EM BRANCO</p>
           </div>
          </div>
          <div id="photos-container" class="hidden flex-shrink-0">
           <div class="relative"><img id="candidate-photo" class="candidate-photo w-32 h-40 object-cover rounded-lg bg-gray-600" src="" alt="Candidato"> <img id="vice-photo" class="hidden candidate-photo w-20 h-24 object-cover rounded-lg bg-gray-600 absolute -bottom-4 -right-4 border-2 border-gray-800" src="" alt="Vice">
           </div>
          </div>
         </div>
         <p id="instruction" class="text-yellow-400 text-sm mt-6"></p>
        </div>
        <div id="voting-end" class="hidden flex items-center justify-center h-full">
         <div class="text-center">
          <p class="text-green-400 text-6xl font-black tracking-wider">FIM</p>
          <p class="text-gray-400 mt-4">Seu voto foi registrado com sucesso!</p>
         </div>
        </div>
       </div>
      </div><!-- Keyboard -->
      <div class="urna-keyboard rounded-2xl p-6">
       <div class="grid grid-cols-3 gap-3 mb-4"><button onclick="pressKey('1')" class="urna-btn text-white text-2xl font-bold py-4 px-6 rounded-lg">1</button> <button onclick="pressKey('2')" class="urna-btn text-white text-2xl font-bold py-4 px-6 rounded-lg">2</button> <button onclick="pressKey('3')" class="urna-btn text-white text-2xl font-bold py-4 px-6 rounded-lg">3</button> <button onclick="pressKey('4')" class="urna-btn text-white text-2xl font-bold py-4 px-6 rounded-lg">4</button> <button onclick="pressKey('5')" class="urna-btn text-white text-2xl font-bold py-4 px-6 rounded-lg">5</button> <button onclick="pressKey('6')" class="urna-btn text-white text-2xl font-bold py-4 px-6 rounded-lg">6</button> <button onclick="pressKey('7')" class="urna-btn text-white text-2xl font-bold py-4 px-6 rounded-lg">7</button> <button onclick="pressKey('8')" class="urna-btn text-white text-2xl font-bold py-4 px-6 rounded-lg">8</button> <button onclick="pressKey('9')" class="urna-btn text-white text-2xl font-bold py-4 px-6 rounded-lg">9</button>
        <div></div><button onclick="pressKey('0')" class="urna-btn text-white text-2xl font-bold py-4 px-6 rounded-lg">0</button>
        <div></div>
       </div>
       <div class="flex gap-3"><button onclick="pressBlank()" class="urna-btn urna-btn-white flex-1 text-sm font-bold py-3 px-4 rounded-lg">BRANCO</button> <button onclick="pressCorrect()" class="urna-btn urna-btn-orange flex-1 text-white text-sm font-bold py-3 px-4 rounded-lg">CORRIGE</button> <button onclick="pressConfirm()" class="urna-btn urna-btn-green flex-1 text-white text-sm font-bold py-3 px-4 rounded-lg">CONFIRMA</button>
       </div>
      </div>
     </div>
    </div>
   </main><!-- Admin Login -->
   <main id="page-admin-login" class="page hidden max-w-md mx-auto px-6 py-12">
    <div class="bg-white rounded-2xl p-8 shadow-xl border border-purple-100 fade-in">
     <div class="text-center mb-6">
      <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
       <svg class="w-8 h-8 text-primary" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
       </svg>
      </div>
      <h2 class="text-2xl font-bold text-gray-800">Acesso Administrativo</h2>
      <p class="text-gray-500 text-sm mt-1">√Årea restrita para administradores</p>
     </div>
     <div class="space-y-4">
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Senha</label> <input type="password" id="admin-password" placeholder="Digite a senha" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none transition">
      </div>
      <p id="admin-error" class="text-red-500 text-sm text-center hidden">Senha incorreta</p>
     </div><button onclick="adminLogin()" class="w-full mt-6 bg-primary hover:bg-primary-dark text-white py-3 px-6 rounded-xl font-semibold transition"> Entrar </button>
    </div>
   </main><!-- Admin Panel -->
   <main id="page-admin" class="page hidden max-w-6xl mx-auto px-6 py-8">
    <div class="flex gap-4 mb-6 overflow-x-auto pb-2"><button onclick="showAdminTab('dashboard')" class="admin-tab px-4 py-2 bg-primary text-white rounded-lg font-medium whitespace-nowrap" data-tab="dashboard">Dashboard</button> <button onclick="showAdminTab('candidates')" class="admin-tab px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium whitespace-nowrap" data-tab="candidates">Candidatos</button> <button onclick="showAdminTab('parties')" class="admin-tab px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium whitespace-nowrap" data-tab="parties">Partidos</button> <button onclick="showAdminTab('voters')" class="admin-tab px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium whitespace-nowrap" data-tab="voters">Eleitores</button> <button onclick="showAdminTab('settings')" class="admin-tab px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium whitespace-nowrap" data-tab="settings">Configura√ß√µes</button> <button onclick="showAdminTab('results')" class="admin-tab px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium whitespace-nowrap" data-tab="results">Apura√ß√£o</button>
    </div><!-- Dashboard Tab -->
    <div id="tab-dashboard" class="admin-tab-content">
     <div class="grid md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-xl p-6 shadow-lg border border-purple-100">
       <p class="text-gray-500 text-sm">Total de Eleitores</p>
       <p id="stat-voters" class="text-3xl font-bold text-primary">0</p>
      </div>
      <div class="bg-white rounded-xl p-6 shadow-lg border border-purple-100">
       <p class="text-gray-500 text-sm">Votos Registrados</p>
       <p id="stat-votes" class="text-3xl font-bold text-green-500">0</p>
      </div>
      <div class="bg-white rounded-xl p-6 shadow-lg border border-purple-100">
       <p class="text-gray-500 text-sm">Candidatos</p>
       <p id="stat-candidates" class="text-3xl font-bold text-blue-500">0</p>
      </div>
      <div class="bg-white rounded-xl p-6 shadow-lg border border-purple-100">
       <p class="text-gray-500 text-sm">Partidos</p>
       <p id="stat-parties" class="text-3xl font-bold text-orange-500">0</p>
      </div>
     </div>
     <div class="bg-white rounded-xl p-6 shadow-lg border border-purple-100">
      <h3 class="text-lg font-bold text-gray-800 mb-4">Status da Elei√ß√£o</h3>
      <div class="flex items-center gap-4"><span id="election-status-badge" class="px-4 py-2 bg-gray-200 text-gray-600 rounded-full font-medium">N√£o Iniciada</span> <span id="election-round-badge" class="px-4 py-2 bg-purple-100 text-primary rounded-full font-medium">1¬∫ Turno</span>
      </div>
     </div>
    </div><!-- Candidates Tab -->
    <div id="tab-candidates" class="admin-tab-content hidden">
     <div class="bg-white rounded-xl p-6 shadow-lg border border-purple-100 mb-6">
      <h3 class="text-lg font-bold text-gray-800 mb-4">Novo Candidato</h3>
      <div class="grid md:grid-cols-2 gap-4"><input type="text" id="cand-name" placeholder="Nome do Candidato" class="px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none"> <input type="text" id="cand-number" placeholder="N√∫mero (2 ou 4 d√≠gitos)" class="px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none"> <select id="cand-party" class="px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none bg-white"> <option value="">Selecione o Partido</option> </select> <select id="cand-position" class="px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none bg-white"> <option value="">Cargo</option> <option value="deputado">Deputado Federal</option> <option value="governador">Governador</option> <option value="presidente">Presidente</option> </select> <select id="cand-state" class="px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none bg-white"> <option value="">Estado (se aplic√°vel)</option> <option value="AM">Amazonas</option> <option value="SP">S√£o Paulo</option> <option value="GO">Goi√°s</option> <option value="RS">Rio Grande do Sul</option> <option value="PE">Pernambuco</option> <option value="federal">Federal</option> </select> <input type="text" id="cand-photo" placeholder="URL da Foto" class="px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none"> <input type="text" id="cand-vice-name" placeholder="Nome do Vice (se aplic√°vel)" class="px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none"> <input type="text" id="cand-vice-photo" placeholder="URL Foto do Vice" class="px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none">
      </div><button onclick="addCandidate()" class="mt-4 bg-primary hover:bg-primary-dark text-white py-3 px-6 rounded-xl font-semibold transition"> Adicionar Candidato </button>
     </div>
     <div class="bg-white rounded-xl p-6 shadow-lg border border-purple-100">
      <h3 class="text-lg font-bold text-gray-800 mb-4">Candidatos Cadastrados</h3>
      <div id="candidates-list" class="space-y-3"></div>
     </div>
    </div><!-- Parties Tab -->
    <div id="tab-parties" class="admin-tab-content hidden">
     <div class="bg-white rounded-xl p-6 shadow-lg border border-purple-100 mb-6">
      <h3 class="text-lg font-bold text-gray-800 mb-4">Novo Partido</h3>
      <div class="grid md:grid-cols-3 gap-4"><input type="text" id="party-name" placeholder="Nome do Partido" class="px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none"> <input type="text" id="party-acronym" placeholder="Sigla (Ex: PTB)" class="px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none"> <input type="text" id="party-number" placeholder="N√∫mero (2 d√≠gitos)" class="px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none">
      </div><button onclick="addParty()" class="mt-4 bg-primary hover:bg-primary-dark text-white py-3 px-6 rounded-xl font-semibold transition"> Adicionar Partido </button>
     </div>
     <div class="bg-white rounded-xl p-6 shadow-lg border border-purple-100">
      <h3 class="text-lg font-bold text-gray-800 mb-4">Partidos Cadastrados</h3>
      <div id="parties-list" class="space-y-3"></div>
     </div>
    </div><!-- Voters Tab -->
    <div id="tab-voters" class="admin-tab-content hidden">
     <div class="bg-white rounded-xl p-6 shadow-lg border border-purple-100">
      <h3 class="text-lg font-bold text-gray-800 mb-4">Eleitores Cadastrados</h3>
      <div id="voters-list" class="space-y-3"></div>
     </div>
    </div><!-- Settings Tab -->
    <div id="tab-settings" class="admin-tab-content hidden">
     <div class="grid md:grid-cols-2 gap-6">
      <div class="bg-white rounded-xl p-6 shadow-lg border border-purple-100">
       <h3 class="text-lg font-bold text-gray-800 mb-4">Cargos Habilitados</h3>
       <div class="space-y-3"><label class="flex items-center gap-3 cursor-pointer"> <input type="checkbox" id="pos-deputado" checked class="w-5 h-5 text-primary rounded"> <span>Deputado Federal</span> </label> <label class="flex items-center gap-3 cursor-pointer"> <input type="checkbox" id="pos-governador" checked class="w-5 h-5 text-primary rounded"> <span>Governador</span> </label> <label class="flex items-center gap-3 cursor-pointer"> <input type="checkbox" id="pos-presidente" checked class="w-5 h-5 text-primary rounded"> <span>Presidente</span> </label>
       </div><button onclick="savePositions()" class="mt-4 bg-primary hover:bg-primary-dark text-white py-2 px-4 rounded-lg font-medium transition"> Salvar Configura√ß√µes </button>
      </div>
      <div class="bg-white rounded-xl p-6 shadow-lg border border-purple-100">
       <h3 class="text-lg font-bold text-gray-800 mb-4">Controle da Elei√ß√£o</h3>
       <div class="space-y-3"><button onclick="startElection()" id="btn-start-election" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 px-6 rounded-xl font-semibold transition"> Iniciar Elei√ß√£o </button> <button onclick="startSecondRound()" id="btn-second-round" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white py-3 px-6 rounded-xl font-semibold transition"> Iniciar 2¬∫ Turno </button> <button onclick="endElection()" id="btn-end-election" class="w-full bg-red-500 hover:bg-red-600 text-white py-3 px-6 rounded-xl font-semibold transition"> Encerrar Elei√ß√£o </button>
       </div>
      </div>
      <div class="bg-white rounded-xl p-6 shadow-lg border border-purple-100">
       <h3 class="text-lg font-bold text-gray-800 mb-4">Votos NPC (Sistema)</h3>
       <p class="text-gray-500 text-sm mb-4">Configure os votos do NPC para cada candidato (representam 50% do resultado final)</p>
       <div id="npc-votes-config" class="space-y-3 max-h-64 overflow-y-auto"></div><button onclick="saveNpcVotes()" class="mt-4 bg-primary hover:bg-primary-dark text-white py-2 px-4 rounded-lg font-medium transition"> Salvar Votos NPC </button>
      </div>
     </div>
    </div><!-- Results Tab -->
    <div id="tab-results" class="admin-tab-content hidden">
     <div class="grid gap-6"><!-- Summary Cards -->
      <div class="grid md:grid-cols-3 gap-4">
       <div class="bg-white rounded-xl p-6 shadow-lg border border-purple-100 text-center">
        <p class="text-gray-500 text-sm">Votos V√°lidos</p>
        <p id="result-valid" class="text-3xl font-bold text-green-500">0</p>
       </div>
       <div class="bg-white rounded-xl p-6 shadow-lg border border-purple-100 text-center">
        <p class="text-gray-500 text-sm">Votos Brancos</p>
        <p id="result-blank" class="text-3xl font-bold text-gray-500">0</p>
       </div>
       <div class="bg-white rounded-xl p-6 shadow-lg border border-purple-100 text-center">
        <p class="text-gray-500 text-sm">Votos Nulos</p>
        <p id="result-null" class="text-3xl font-bold text-red-500">0</p>
       </div>
      </div><!-- Results by Position -->
      <div class="bg-white rounded-xl p-6 shadow-lg border border-purple-100">
       <h3 class="text-lg font-bold text-gray-800 mb-4">Resultados por Cargo</h3>
       <div class="flex gap-2 mb-4 flex-wrap"><button onclick="showResultsFor('presidente')" class="result-tab px-4 py-2 bg-primary text-white rounded-lg font-medium">Presidente</button> <button onclick="showResultsFor('governador')" class="result-tab px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium">Governador</button> <button onclick="showResultsFor('deputado')" class="result-tab px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium">Deputado</button>
       </div>
       <div id="results-table" class="overflow-x-auto">
        <table class="w-full text-left">
         <thead class="bg-gray-50">
          <tr>
           <th class="px-4 py-3 font-semibold text-gray-700">Candidato</th>
           <th class="px-4 py-3 font-semibold text-gray-700">Partido</th>
           <th class="px-4 py-3 font-semibold text-gray-700">Votos Jogadores</th>
           <th class="px-4 py-3 font-semibold text-gray-700">Votos NPC</th>
           <th class="px-4 py-3 font-semibold text-gray-700">Total Final</th>
           <th class="px-4 py-3 font-semibold text-gray-700">%</th>
          </tr>
         </thead>
         <tbody id="results-body"></tbody>
        </table>
       </div>
      </div><!-- Charts -->
      <div class="grid md:grid-cols-2 gap-6">
       <div class="bg-white rounded-xl p-6 shadow-lg border border-purple-100">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Gr√°fico de Barras</h3>
        <div id="bar-chart" class="space-y-3"></div>
       </div>
       <div class="bg-white rounded-xl p-6 shadow-lg border border-purple-100">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Distribui√ß√£o de Votos</h3>
        <div id="pie-chart" class="flex items-center justify-center">
         <svg id="pie-svg" width="200" height="200" viewbox="0 0 200 200"></svg>
        </div>
        <div id="pie-legend" class="mt-4 flex flex-wrap gap-2 justify-center"></div>
       </div>
      </div><!-- Calculation Explanation -->
      <div class="bg-purple-50 rounded-xl p-6 border border-purple-200">
       <h3 class="text-lg font-bold text-primary mb-2">üìä Como √© calculado o resultado final?</h3>
       <p class="text-gray-700">O resultado final √© a m√©dia ponderada entre os votos dos jogadores e os votos do NPC (sistema):</p>
       <div class="bg-white rounded-lg p-4 mt-3 font-mono text-sm">
        <p><strong>Resultado Final = (Votos Jogadores √ó 50%) + (Votos NPC √ó 50%)</strong></p>
       </div>
      </div>
     </div>
    </div>
   </main><!-- Toast Notification -->
   <div id="toast" class="fixed bottom-6 right-6 bg-gray-800 text-white px-6 py-3 rounded-xl shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">
    <p id="toast-message"></p>
   </div>
  </div>
  <script>
    // State
    let appData = {
      voters: [],
      candidates: [],
      parties: [],
      votes: [],
      settings: null
    };
    let currentVoter = null;
    let currentNumber = '';
    let currentPosition = 0;
    let votingPositions = [];
    let currentVotes = {};
    let isAdmin = false;
    let currentResultsPosition = 'presidente';

    // Config
    const defaultConfig = {
      main_title: 'Urna Eletr√¥nica NGv',
      subtitle: 'Nosso Governo Virtual'
    };
    let config = { ...defaultConfig };

    // SDK Initialization
    const dataHandler = {
      onDataChanged(data) {
        appData.voters = data.filter(d => d.type === 'voter');
        appData.candidates = data.filter(d => d.type === 'candidate');
        appData.parties = data.filter(d => d.type === 'party');
        appData.votes = data.filter(d => d.type === 'vote');
        appData.settings = data.find(d => d.type === 'settings');
        
        updateUI();
      }
    };

    async function initApp() {
      try {
        if (window.dataSdk) {
          const result = await window.dataSdk.init(dataHandler);
          if (!result.isOk) {
            console.error('Data SDK init failed');
          }
        }
        
        if (window.elementSdk) {
          window.elementSdk.init({
            defaultConfig,
            onConfigChange: async (cfg) => {
              config = { ...defaultConfig, ...cfg };
              document.getElementById('header-title').textContent = config.main_title;
              document.getElementById('header-subtitle').textContent = config.subtitle;
            },
            mapToCapabilities: (cfg) => ({
              recolorables: [],
              borderables: [],
              fontEditable: undefined,
              fontSizeable: undefined
            }),
            mapToEditPanelValues: (cfg) => new Map([
              ['main_title', cfg.main_title || defaultConfig.main_title],
              ['subtitle', cfg.subtitle || defaultConfig.subtitle]
            ])
          });
        }
      } catch (e) {
        console.error('Init error:', e);
      }
    }

    initApp();

    // Navigation
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
      document.getElementById('page-' + pageId)?.classList.remove('hidden');
    }

    function showAdminTab(tabId) {
      document.querySelectorAll('.admin-tab-content').forEach(t => t.classList.add('hidden'));
      document.getElementById('tab-' + tabId)?.classList.remove('hidden');
      document.querySelectorAll('.admin-tab').forEach(t => {
        t.classList.remove('bg-primary', 'text-white');
        t.classList.add('bg-gray-200', 'text-gray-700');
      });
      document.querySelector(`.admin-tab[data-tab="${tabId}"]`)?.classList.remove('bg-gray-200', 'text-gray-700');
      document.querySelector(`.admin-tab[data-tab="${tabId}"]`)?.classList.add('bg-primary', 'text-white');
    }

    // Toast
    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      const toastMsg = document.getElementById('toast-message');
      toastMsg.textContent = message;
      toast.classList.remove('translate-y-20', 'opacity-0');
      toast.classList.toggle('bg-red-500', isError);
      toast.classList.toggle('bg-gray-800', !isError);
      setTimeout(() => {
        toast.classList.add('translate-y-20', 'opacity-0');
      }, 3000);
    }

    // Voter Registration
    async function registerVoter() {
      const discord = document.getElementById('discord-user').value.trim();
      const character = document.getElementById('character-name').value.trim();
      const state = document.getElementById('voter-state').value;

      if (!discord || !character || !state) {
        showToast('Preencha todos os campos!', true);
        return;
      }

      // Check if already registered
      const existing = appData.voters.find(v => v.discord_user === discord);
      if (existing) {
        showToast('Este usu√°rio j√° est√° cadastrado!', true);
        return;
      }

      // Generate unique code
      const code = 'NGV-' + Math.random().toString(36).substring(2, 8).toUpperCase();

      const btn = document.getElementById('btn-register');
      btn.disabled = true;
      btn.textContent = 'Gerando c√≥digo...';

      try {
        if (!window.dataSdk) {
          showToast('Sistema n√£o inicializado. Tente recarregar a p√°gina.', true);
          btn.disabled = false;
          btn.textContent = 'Gerar C√≥digo de Vota√ß√£o';
          return;
        }

        const result = await window.dataSdk.create({
          type: 'voter',
          discord_user: discord,
          character_name: character,
          state: state,
          voting_code: code,
          code_used: false,
          votes: '',
          created_at: new Date().toISOString()
        });

        if (result.isOk) {
          document.getElementById('register-form').classList.add('hidden');
          document.getElementById('register-success').classList.remove('hidden');
          document.getElementById('voting-code').textContent = code;
          currentVoter = { discord_user: discord, character_name: character, state: state, voting_code: code };
        } else {
          showToast('Erro ao cadastrar. ' + (result.error?.message || 'Tente novamente.'), true);
        }
      } catch (e) {
        showToast('Erro ao cadastrar: ' + e.message, true);
      }

      btn.disabled = false;
      btn.textContent = 'Gerar C√≥digo de Vota√ß√£o';
    }

    function goToVoting() {
      showPage('voting-entry');
    }

    // Validate Code
    async function validateCode() {
      const code = document.getElementById('entry-code').value.trim().toUpperCase();
      const errorEl = document.getElementById('code-error');
      
      if (!code) {
        errorEl.textContent = 'Digite o c√≥digo de vota√ß√£o';
        errorEl.classList.remove('hidden');
        return;
      }

      const voter = appData.voters.find(v => v.voting_code === code);
      
      if (!voter) {
        errorEl.textContent = 'C√≥digo inv√°lido';
        errorEl.classList.remove('hidden');
        return;
      }

      if (voter.code_used) {
        errorEl.textContent = 'Este c√≥digo j√° foi utilizado';
        errorEl.classList.remove('hidden');
        return;
      }

      // Check if election is active
      if (!appData.settings || appData.settings.election_status !== 'active') {
        errorEl.textContent = 'A elei√ß√£o n√£o est√° ativa no momento';
        errorEl.classList.remove('hidden');
        return;
      }

      errorEl.classList.add('hidden');
      currentVoter = voter;
      startVoting();
    }

    // Voting Machine
    function startVoting() {
      showPage('voting');
      currentNumber = '';
      currentPosition = 0;
      currentVotes = {};
      
      // Determine positions based on settings
      votingPositions = [];
      const posEnabled = appData.settings?.positions_enabled ? JSON.parse(appData.settings.positions_enabled) : { deputado: true, governador: true, presidente: true };
      
      if (posEnabled.deputado) votingPositions.push({ id: 'deputado', label: 'DEPUTADO FEDERAL', digits: 4 });
      if (posEnabled.governador) votingPositions.push({ id: 'governador', label: 'GOVERNADOR', digits: 2 });
      if (posEnabled.presidente) votingPositions.push({ id: 'presidente', label: 'PRESIDENTE', digits: 2 });

      if (votingPositions.length === 0) {
        showToast('Nenhum cargo habilitado para vota√ß√£o', true);
        showPage('home');
        return;
      }

      updateVotingScreen();
    }

    function updateVotingScreen() {
      const pos = votingPositions[currentPosition];
      document.getElementById('cargo-label').textContent = pos.label;
      document.getElementById('number-display').textContent = currentNumber.padEnd(pos.digits, '_').split('').join(' ');
      
      // Reset display
      document.getElementById('candidate-info').classList.add('hidden');
      document.getElementById('vote-null').classList.add('hidden');
      document.getElementById('vote-blank').classList.add('hidden');
      document.getElementById('photos-container').classList.add('hidden');
      document.getElementById('vice-info').classList.add('hidden');
      document.getElementById('vice-photo').classList.add('hidden');
      
      // Check if number is complete
      if (currentNumber.length >= 2) {
        findCandidate();
      }
      
      updateInstruction();
    }

    function findCandidate() {
      const pos = votingPositions[currentPosition];
      let candidate = null;
      
      // For deputies, check if it's a legend vote (2 digits) or candidate vote (4 digits)
      if (pos.id === 'deputado') {
        if (currentNumber.length === 2) {
          // Legend vote
          const party = appData.parties.find(p => p.party_number === currentNumber);
          if (party) {
            document.getElementById('candidate-info').classList.remove('hidden');
            document.getElementById('candidate-name').textContent = 'VOTO DE LEGENDA';
            document.getElementById('candidate-party').textContent = party.party_name + ' (' + party.party_acronym + ')';
            return;
          }
        } else if (currentNumber.length === 4) {
          candidate = appData.candidates.find(c => 
            c.candidate_number === currentNumber && 
            c.candidate_position === 'deputado' &&
            c.candidate_state === currentVoter.state
          );
        }
      } else {
        candidate = appData.candidates.find(c => 
          c.candidate_number === currentNumber && 
          c.candidate_position === pos.id &&
          (pos.id === 'presidente' || c.candidate_state === currentVoter.state)
        );
      }

      if (candidate) {
        document.getElementById('candidate-info').classList.remove('hidden');
        document.getElementById('candidate-name').textContent = candidate.candidate_name;
        document.getElementById('candidate-party').textContent = candidate.candidate_party;
        
        if (candidate.candidate_photo) {
          document.getElementById('photos-container').classList.remove('hidden');
          document.getElementById('candidate-photo').src = candidate.candidate_photo;
          document.getElementById('candidate-photo').onerror = function() {
            this.style.background = '#6B21A8';
            this.alt = 'Foto n√£o dispon√≠vel';
          };
        }

        if (candidate.candidate_vice_name) {
          document.getElementById('vice-info').classList.remove('hidden');
          document.getElementById('vice-name').textContent = candidate.candidate_vice_name;
          
          if (candidate.candidate_vice_photo) {
            document.getElementById('vice-photo').classList.remove('hidden');
            document.getElementById('vice-photo').src = candidate.candidate_vice_photo;
            document.getElementById('vice-photo').onerror = function() {
              this.style.background = '#9333EA';
              this.alt = 'Foto n√£o dispon√≠vel';
            };
          }
        }
      } else if (currentNumber.length >= pos.digits) {
        document.getElementById('vote-null').classList.remove('hidden');
      }
    }

    function updateInstruction() {
      const pos = votingPositions[currentPosition];
      let instruction = '';
      
      if (currentNumber.length < pos.digits) {
        instruction = `Digite o n√∫mero do candidato (${pos.digits} d√≠gitos)`;
        if (pos.id === 'deputado') {
          instruction += ' ou da legenda (2 d√≠gitos)';
        }
      } else {
        instruction = 'Aperte CONFIRMA para votar ou CORRIGE para alterar';
      }
      
      document.getElementById('instruction').textContent = instruction;
    }

    function pressKey(num) {
      const pos = votingPositions[currentPosition];
      if (currentNumber.length < pos.digits) {
        currentNumber += num;
        updateVotingScreen();
      }
    }

    function pressBlank() {
      currentNumber = '';
      document.getElementById('candidate-info').classList.add('hidden');
      document.getElementById('vote-null').classList.add('hidden');
      document.getElementById('photos-container').classList.add('hidden');
      document.getElementById('vote-blank').classList.remove('hidden');
      
      const pos = votingPositions[currentPosition];
      document.getElementById('number-display').textContent = '_ '.repeat(pos.digits);
      document.getElementById('instruction').textContent = 'Aperte CONFIRMA para votar em branco';
    }

    function pressCorrect() {
      currentNumber = '';
      document.getElementById('vote-blank').classList.add('hidden');
      updateVotingScreen();
    }

    async function pressConfirm() {
      const pos = votingPositions[currentPosition];
      const isBlank = document.getElementById('vote-blank').classList.contains('hidden') === false;
      
      // Store vote
      if (isBlank) {
        currentVotes[pos.id] = 'BRANCO';
      } else if (currentNumber.length === 0) {
        return; // Nothing to confirm
      } else {
        currentVotes[pos.id] = currentNumber;
      }

      // Move to next position or finish
      currentPosition++;
      currentNumber = '';
      
      if (currentPosition >= votingPositions.length) {
        await finishVoting();
      } else {
        updateVotingScreen();
      }
    }

    async function finishVoting() {
      // Show FIM screen
      document.getElementById('voting-content').classList.add('hidden');
      document.getElementById('voting-end').classList.remove('hidden');

      // Save vote
      try {
        await window.dataSdk.create({
          type: 'vote',
          discord_user: currentVoter.discord_user,
          character_name: currentVoter.character_name,
          state: currentVoter.state,
          votes: JSON.stringify(currentVotes),
          created_at: new Date().toISOString()
        });

        // Mark code as used
        const voterRecord = appData.voters.find(v => v.voting_code === currentVoter.voting_code);
        if (voterRecord) {
          await window.dataSdk.update({
            ...voterRecord,
            code_used: true
          });
        }
      } catch (e) {
        console.error('Error saving vote:', e);
      }

      setTimeout(() => {
        showPage('home');
        document.getElementById('voting-content').classList.remove('hidden');
        document.getElementById('voting-end').classList.add('hidden');
        showToast('Voto registrado com sucesso!');
      }, 3000);
    }

    // Admin Functions
    function adminLogin() {
      const password = document.getElementById('admin-password').value;
      if (password === 'ngv2024') {
        isAdmin = true;
        showPage('admin');
        updateUI();
      } else {
        document.getElementById('admin-error').classList.remove('hidden');
      }
    }

    async function addCandidate() {
      const name = document.getElementById('cand-name').value.trim();
      const number = document.getElementById('cand-number').value.trim();
      const party = document.getElementById('cand-party').value;
      const position = document.getElementById('cand-position').value;
      const state = document.getElementById('cand-state').value;
      const photo = document.getElementById('cand-photo').value.trim();
      const viceName = document.getElementById('cand-vice-name').value.trim();
      const vicePhoto = document.getElementById('cand-vice-photo').value.trim();

      if (!name || !number || !party || !position) {
        showToast('Preencha os campos obrigat√≥rios!', true);
        return;
      }

      if (appData.candidates.length >= 999) {
        showToast('Limite de 999 candidatos atingido!', true);
        return;
      }

      try {
        if (!window.dataSdk) {
          showToast('Sistema n√£o inicializado. Tente recarregar a p√°gina.', true);
          return;
        }

        const result = await window.dataSdk.create({
          type: 'candidate',
          candidate_name: name,
          candidate_number: number,
          candidate_party: party,
          candidate_position: position,
          candidate_state: state || '',
          candidate_photo: photo,
          candidate_vice_name: viceName,
          candidate_vice_photo: vicePhoto,
          created_at: new Date().toISOString()
        });

        if (result.isOk) {
          showToast('Candidato adicionado!');
          // Clear form
          ['cand-name', 'cand-number', 'cand-photo', 'cand-vice-name', 'cand-vice-photo'].forEach(id => {
            document.getElementById(id).value = '';
          });
          document.getElementById('cand-party').value = '';
          document.getElementById('cand-position').value = '';
          document.getElementById('cand-state').value = '';
        } else {
          showToast('Erro ao adicionar: ' + (result.error?.message || 'Tente novamente'), true);
        }
      } catch (e) {
        showToast('Erro ao adicionar candidato: ' + e.message, true);
      }
    }

    async function deleteCandidate(backendId) {
      const candidate = appData.candidates.find(c => c.__backendId === backendId);
      if (candidate) {
        try {
          await window.dataSdk.delete(candidate);
          showToast('Candidato removido!');
        } catch (e) {
          showToast('Erro ao remover', true);
        }
      }
    }

    async function addParty() {
      const name = document.getElementById('party-name').value.trim();
      const acronym = document.getElementById('party-acronym').value.trim().toUpperCase();
      const number = document.getElementById('party-number').value.trim();

      if (!name || !acronym || !number) {
        showToast('Preencha todos os campos!', true);
        return;
      }

      if (appData.parties.length >= 999) {
        showToast('Limite de 999 partidos atingido!', true);
        return;
      }

      try {
        if (!window.dataSdk) {
          showToast('Sistema n√£o inicializado. Tente recarregar a p√°gina.', true);
          return;
        }

        const result = await window.dataSdk.create({
          type: 'party',
          party_name: name,
          party_acronym: acronym,
          party_number: number,
          created_at: new Date().toISOString()
        });

        if (result.isOk) {
          showToast('Partido adicionado!');
          ['party-name', 'party-acronym', 'party-number'].forEach(id => {
            document.getElementById(id).value = '';
          });
        } else {
          showToast('Erro ao adicionar: ' + (result.error?.message || 'Tente novamente'), true);
        }
      } catch (e) {
        showToast('Erro ao adicionar partido: ' + e.message, true);
      }
    }

    async function deleteParty(backendId) {
      const party = appData.parties.find(p => p.__backendId === backendId);
      if (party) {
        try {
          await window.dataSdk.delete(party);
          showToast('Partido removido!');
        } catch (e) {
          showToast('Erro ao remover', true);
        }
      }
    }

    async function deleteVoter(backendId) {
      const voter = appData.voters.find(v => v.__backendId === backendId);
      if (voter) {
        try {
          await window.dataSdk.delete(voter);
          showToast('Eleitor removido!');
        } catch (e) {
          showToast('Erro ao remover', true);
        }
      }
    }

    async function savePositions() {
      const positions = {
        deputado: document.getElementById('pos-deputado').checked,
        governador: document.getElementById('pos-governador').checked,
        presidente: document.getElementById('pos-presidente').checked
      };

      try {
        if (appData.settings) {
          await window.dataSdk.update({
            ...appData.settings,
            positions_enabled: JSON.stringify(positions)
          });
        } else {
          await window.dataSdk.create({
            type: 'settings',
            election_status: 'inactive',
            election_round: 1,
            positions_enabled: JSON.stringify(positions),
            npc_votes: '{}',
            archived_results: '[]'
          });
        }
        showToast('Configura√ß√µes salvas!');
      } catch (e) {
        showToast('Erro ao salvar', true);
      }
    }

    async function startElection() {
      try {
        if (appData.settings) {
          await window.dataSdk.update({
            ...appData.settings,
            election_status: 'active',
            election_round: 1
          });
        } else {
          await window.dataSdk.create({
            type: 'settings',
            election_status: 'active',
            election_round: 1,
            positions_enabled: JSON.stringify({ deputado: true, governador: true, presidente: true }),
            npc_votes: '{}',
            archived_results: '[]'
          });
        }
        showToast('Elei√ß√£o iniciada!');
      } catch (e) {
        showToast('Erro ao iniciar', true);
      }
    }

    async function startSecondRound() {
      try {
        if (appData.settings) {
          await window.dataSdk.update({
            ...appData.settings,
            election_status: 'active',
            election_round: 2
          });
          showToast('2¬∫ Turno iniciado!');
        }
      } catch (e) {
        showToast('Erro ao iniciar 2¬∫ turno', true);
      }
    }

    async function endElection() {
      try {
        // Archive results
        const results = calculateResults();
        const archived = appData.settings?.archived_results ? JSON.parse(appData.settings.archived_results) : [];
        archived.push({
          date: new Date().toISOString(),
          round: appData.settings?.election_round || 1,
          results: results
        });

        await window.dataSdk.update({
          ...appData.settings,
          election_status: 'ended',
          archived_results: JSON.stringify(archived)
        });

        // Delete all votes
        for (const vote of appData.votes) {
          await window.dataSdk.delete(vote);
        }

        // Reset voter codes
        for (const voter of appData.voters) {
          await window.dataSdk.update({
            ...voter,
            code_used: false,
            voting_code: 'NGV-' + Math.random().toString(36).substring(2, 8).toUpperCase()
          });
        }

        showToast('Elei√ß√£o encerrada! Resultados arquivados.');
      } catch (e) {
        showToast('Erro ao encerrar', true);
      }
    }

    async function saveNpcVotes() {
      const npcVotes = {};
      appData.candidates.forEach(c => {
        const input = document.getElementById('npc-' + c.__backendId);
        if (input) {
          npcVotes[c.__backendId] = parseInt(input.value) || 0;
        }
      });

      try {
        if (appData.settings) {
          await window.dataSdk.update({
            ...appData.settings,
            npc_votes: JSON.stringify(npcVotes)
          });
          showToast('Votos NPC salvos!');
        }
      } catch (e) {
        showToast('Erro ao salvar', true);
      }
    }

    // Results
    function showResultsFor(position) {
      currentResultsPosition = position;
      document.querySelectorAll('.result-tab').forEach(t => {
        t.classList.remove('bg-primary', 'text-white');
        t.classList.add('bg-gray-200', 'text-gray-700');
      });
      event.target.classList.remove('bg-gray-200', 'text-gray-700');
      event.target.classList.add('bg-primary', 'text-white');
      updateResultsTable();
    }

    function calculateResults() {
      const results = {};
      const npcVotes = appData.settings?.npc_votes ? JSON.parse(appData.settings.npc_votes) : {};

      appData.candidates.forEach(c => {
        const playerVotes = appData.votes.filter(v => {
          const votes = JSON.parse(v.votes);
          return votes[c.candidate_position] === c.candidate_number;
        }).length;

        const npc = npcVotes[c.__backendId] || 0;
        const finalScore = (playerVotes * 0.5) + (npc * 0.5);

        results[c.__backendId] = {
          candidate: c,
          playerVotes,
          npcVotes: npc,
          finalScore
        };
      });

      return results;
    }

    function updateResultsTable() {
      const results = calculateResults();
      const filteredResults = Object.values(results).filter(r => 
        r.candidate.candidate_position === currentResultsPosition
      ).sort((a, b) => b.finalScore - a.finalScore);

      const totalFinal = filteredResults.reduce((sum, r) => sum + r.finalScore, 0);

      const tbody = document.getElementById('results-body');
      tbody.innerHTML = filteredResults.map(r => `
        <tr class="border-b hover:bg-gray-50">
          <td class="px-4 py-3 font-medium">${r.candidate.candidate_name}</td>
          <td class="px-4 py-3">${r.candidate.candidate_party}</td>
          <td class="px-4 py-3">${r.playerVotes}</td>
          <td class="px-4 py-3">${r.npcVotes}</td>
          <td class="px-4 py-3 font-bold text-primary">${r.finalScore.toFixed(1)}</td>
          <td class="px-4 py-3">${totalFinal > 0 ? ((r.finalScore / totalFinal) * 100).toFixed(1) : 0}%</td>
        </tr>
      `).join('');

      // Update bar chart
      const barChart = document.getElementById('bar-chart');
      const maxScore = Math.max(...filteredResults.map(r => r.finalScore), 1);
      barChart.innerHTML = filteredResults.slice(0, 5).map(r => `
        <div class="flex items-center gap-3">
          <div class="w-24 text-sm text-gray-600 truncate">${r.candidate.candidate_name.split(' ')[0]}</div>
          <div class="flex-1 bg-gray-200 rounded-full h-6 overflow-hidden">
            <div class="bg-primary h-full rounded-full transition-all duration-500" style="width: ${(r.finalScore / maxScore) * 100}%"></div>
          </div>
          <div class="w-16 text-sm font-bold text-right">${r.finalScore.toFixed(1)}</div>
        </div>
      `).join('');

      // Update pie chart
      updatePieChart(filteredResults);

      // Update summary
      const blankVotes = appData.votes.filter(v => {
        const votes = JSON.parse(v.votes);
        return votes[currentResultsPosition] === 'BRANCO';
      }).length;

      const nullVotes = appData.votes.filter(v => {
        const votes = JSON.parse(v.votes);
        const num = votes[currentResultsPosition];
        return num && num !== 'BRANCO' && !filteredResults.some(r => r.candidate.candidate_number === num);
      }).length;

      document.getElementById('result-valid').textContent = filteredResults.reduce((sum, r) => sum + r.playerVotes, 0);
      document.getElementById('result-blank').textContent = blankVotes;
      document.getElementById('result-null').textContent = nullVotes;
    }

    function updatePieChart(results) {
      const svg = document.getElementById('pie-svg');
      const legend = document.getElementById('pie-legend');
      const total = results.reduce((sum, r) => sum + r.finalScore, 0);
      
      if (total === 0) {
        svg.innerHTML = '<text x="100" y="100" text-anchor="middle" fill="#999">Sem dados</text>';
        legend.innerHTML = '';
        return;
      }

      const colors = ['#6B21A8', '#9333EA', '#A855F7', '#C084FC', '#DDD6FE', '#818CF8', '#4F46E5'];
      let currentAngle = 0;
      let paths = '';
      let legendHtml = '';

      results.slice(0, 7).forEach((r, i) => {
        const percentage = r.finalScore / total;
        const angle = percentage * 360;
        const largeArc = angle > 180 ? 1 : 0;
        
        const startX = 100 + 80 * Math.cos((currentAngle - 90) * Math.PI / 180);
        const startY = 100 + 80 * Math.sin((currentAngle - 90) * Math.PI / 180);
        const endX = 100 + 80 * Math.cos((currentAngle + angle - 90) * Math.PI / 180);
        const endY = 100 + 80 * Math.sin((currentAngle + angle - 90) * Math.PI / 180);

        paths += `<path d="M100,100 L${startX},${startY} A80,80 0 ${largeArc},1 ${endX},${endY} Z" fill="${colors[i % colors.length]}"/>`;
        legendHtml += `<div class="flex items-center gap-2"><div class="w-3 h-3 rounded" style="background: ${colors[i % colors.length]}"></div><span class="text-xs">${r.candidate.candidate_name.split(' ')[0]}</span></div>`;
        
        currentAngle += angle;
      });

      svg.innerHTML = paths;
      legend.innerHTML = legendHtml;
    }

    // UI Update
    function updateUI() {
      // Stats
      document.getElementById('stat-voters').textContent = appData.voters.length;
      document.getElementById('stat-votes').textContent = appData.votes.length;
      document.getElementById('stat-candidates').textContent = appData.candidates.length;
      document.getElementById('stat-parties').textContent = appData.parties.length;

      // Election status
      if (appData.settings) {
        const statusBadge = document.getElementById('election-status-badge');
        const roundBadge = document.getElementById('election-round-badge');
        
        if (appData.settings.election_status === 'active') {
          statusBadge.textContent = 'Em Andamento';
          statusBadge.className = 'px-4 py-2 bg-green-100 text-green-700 rounded-full font-medium';
        } else if (appData.settings.election_status === 'ended') {
          statusBadge.textContent = 'Encerrada';
          statusBadge.className = 'px-4 py-2 bg-red-100 text-red-700 rounded-full font-medium';
        } else {
          statusBadge.textContent = 'N√£o Iniciada';
          statusBadge.className = 'px-4 py-2 bg-gray-200 text-gray-600 rounded-full font-medium';
        }

        roundBadge.textContent = (appData.settings.election_round || 1) + '¬∫ Turno';

        // Load positions
        const posEnabled = appData.settings.positions_enabled ? JSON.parse(appData.settings.positions_enabled) : { deputado: true, governador: true, presidente: true };
        document.getElementById('pos-deputado').checked = posEnabled.deputado !== false;
        document.getElementById('pos-governador').checked = posEnabled.governador !== false;
        document.getElementById('pos-presidente').checked = posEnabled.presidente !== false;
      }

      // Candidates list
      const candList = document.getElementById('candidates-list');
      if (appData.candidates.length === 0) {
        candList.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum candidato cadastrado</p>';
      } else {
        candList.innerHTML = appData.candidates.map(c => `
          <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
            <div class="flex items-center gap-4">
              ${c.candidate_photo ? `<img src="${c.candidate_photo}" class="w-12 h-12 rounded-full object-cover" onerror="this.style.background='#6B21A8'; this.src='';">` : '<div class="w-12 h-12 rounded-full bg-primary/20"></div>'}
              <div>
                <p class="font-semibold">${c.candidate_name}</p>
                <p class="text-sm text-gray-500">${c.candidate_number} - ${c.candidate_party} - ${c.candidate_position.charAt(0).toUpperCase() + c.candidate_position.slice(1)}</p>
              </div>
            </div>
            <button onclick="deleteCandidate('${c.__backendId}')" class="text-red-500 hover:text-red-700 p-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </div>
        `).join('');
      }

      // Parties list
      const partyList = document.getElementById('parties-list');
      if (appData.parties.length === 0) {
        partyList.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum partido cadastrado</p>';
      } else {
        partyList.innerHTML = appData.parties.map(p => `
          <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
            <div>
              <p class="font-semibold">${p.party_name}</p>
              <p class="text-sm text-gray-500">${p.party_acronym} - N¬∫ ${p.party_number}</p>
            </div>
            <button onclick="deleteParty('${p.__backendId}')" class="text-red-500 hover:text-red-700 p-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </div>
        `).join('');
      }

      // Party select for candidates
      const partySelect = document.getElementById('cand-party');
      partySelect.innerHTML = '<option value="">Selecione o Partido</option>' + 
        appData.parties.map(p => `<option value="${p.party_name} (${p.party_acronym})">${p.party_name} (${p.party_acronym})</option>`).join('');

      // Voters list
      const votersList = document.getElementById('voters-list');
      if (appData.voters.length === 0) {
        votersList.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum eleitor cadastrado</p>';
      } else {
        votersList.innerHTML = appData.voters.map(v => `
          <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
            <div>
              <p class="font-semibold">${v.character_name}</p>
              <p class="text-sm text-gray-500">${v.discord_user} - ${v.state}</p>
              <p class="text-xs ${v.code_used ? 'text-red-500' : 'text-green-500'}">${v.code_used ? 'J√° votou' : 'Ainda n√£o votou'}</p>
            </div>
            <button onclick="deleteVoter('${v.__backendId}')" class="text-red-500 hover:text-red-700 p-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </div>
        `).join('');
      }

      // NPC Votes config
      const npcConfig = document.getElementById('npc-votes-config');
      const npcVotes = appData.settings?.npc_votes ? JSON.parse(appData.settings.npc_votes) : {};
      npcConfig.innerHTML = appData.candidates.map(c => `
        <div class="flex items-center gap-3">
          <span class="flex-1 text-sm">${c.candidate_name} (${c.candidate_position})</span>
          <input type="number" id="npc-${c.__backendId}" value="${npcVotes[c.__backendId] || 0}" min="0" class="w-20 px-2 py-1 border rounded text-center">
        </div>
      `).join('');

      // Update results if on results tab
      if (!document.getElementById('tab-results').classList.contains('hidden')) {
        updateResultsTable();
      }
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9d483c0aa412e41d',t:'MTc3MjIwMTEwMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>